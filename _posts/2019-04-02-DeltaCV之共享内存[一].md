---
layout: post
title: "DeltaCV之共享内存[一]"
date: 2019-04-02
categories:
- DeltaCV
tag:
- DeltaCV
- 共享内存
- C++
excerpt: 这篇文章我们来认识一下线程间通信的一种手段—共享内存，共享内存由于其特殊性—共享内存是存在与每个进程的地址空间中的，通俗点就是这部分数据是对每个进程可见的，这样每个进程都可以在一定条件下直接操作共享内存中的数据，避免了数据的复制等耗时的操作，这也是共享内存比其他几种IPC机制（信号量、管道、消息队列等）的通信方式效率高的原因，但是共享内存也有缺点，那就是需要独立实现消息的同步机制。
---

这篇文章我们来认识一下线程间通信的一种手段—共享内存，共享内存由于其特殊性—共享内存是存在与每个进程的地址空间中的，通俗点就是这部分数据是对每个进程可见的，这样每个进程都可以在一定条件下直接操作共享内存中的数据，避免了数据的复制等耗时的操作，这也是共享内存比其他几种IPC机制（信号量、管道、消息队列等）的通信方式效率高的原因，但是共享内存也有缺点，那就是需要独立实现消息的同步机制。

本文将完成一个基础的共享内存模板类，包含在[DeltaCV](https://github.com/DasudaRunner/DeltaCV)项目中，欢迎star，fork。

## 概述
在boost/Interprocess中，提供了很多关于操作系统底层的进程间通信的抽象层，它使用C++将操作系统的底层接口进行封装，并消除了不同操作系统之间各种各样的接口带来的开发困难等问题。

### 共享内存
先介绍一种最普通的共享内存创建方式，boost::interprocess::shared_memory_object类。
```cpp
#include <boost/interprocess/shared_memory_object.hpp> 
// boost::interprocess::open_or_create： 第一个参数说明了当前的操作是什么，直接可以根据字面意思猜测到，open_or_create指如果尝试打开名字为DeltaCV的共享内存失败时，就创建它，当然也有create_only，open_only操作。
// "DeltaCV"： 表明当前我们操作的共享内存的名字为DeltaCV。
// boost::interprocess::read_write： 所有进程对此共享内存的操作权限（暂且可以这样认为，感觉不太严谨），read_write即可读写，同时还有read_only供选择。
boost::interprocess::shared_memory_object shm(boost::interprocess::open_or_create, "DeltaCV", boost::interprocess::read_write); 
```
共享内存创建后大小为0，我们使用truncate()方法来为共享内存设定大小，单位为字节。
```cpp
// 为刚才创建的共享内存开辟1024个字节大小的空间。
shm.truncate(1024);
```
然而刚才我们创建的共享内存虽然对所有进程可见，但是现在还不能直接操作，因为每个进程都有自己独立的地址空间，我们还需要将上面的共享内存映射进当前进程的地址空间中，可以使用mapped_region()方法完成.。
```cpp
#include <boost/interprocess/mapped_region.hpp> 
//shm: 传入上文实例化的共享内存对象
//boost::interprocess::read_write： 当前进程对此共享内存的操作权限
/* 
	当然它的原型如下
			mapped_region region(
				shm,         //Memory-mappable object  
   				mode,        //Access mode  
				start,       //Offset from the beginning of shm 
				end          //Length of the region  
   			);  
   	当你省略后面两个参数时，将默认映射整个共享内存对象
*/
boost::interprocess::mapped_region region(shm, boost::interprocess::read_write);
```


参考文献：http://zh.highscore.de/cpp/boost/interprocesscommunication.html
